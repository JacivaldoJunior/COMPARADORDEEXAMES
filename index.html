<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Comparador de Exames</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white shadow-lg rounded-lg p-8">
    <h1 class="text-3xl font-bold text-center text-green-700 mb-6">Comparador de Exames Laboratoriais</h1>

    <!-- Upload -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div>
        <label class="block font-semibold mb-2">LaboratÃ³rio Apoio A:</label>
        <input type="file" id="fileA" class="w-full border rounded p-2" />
      </div>
      <div>
        <label class="block font-semibold mb-2">LaboratÃ³rio Apoio B:</label>
        <input type="file" id="fileB" class="w-full border rounded p-2" />
      </div>
      <div>
        <label class="block font-semibold mb-2">Tabela ConvÃªnio:</label>
        <input type="file" id="fileConvenio" class="w-full border rounded p-2" />
      </div>
    </div>

    <!-- BotÃµes -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
      <button onclick="compararPlanilhas()" class="bg-blue-600 text-white p-3 rounded font-semibold hover:bg-blue-700">ðŸ”„ Comparar A e B</button>
      <button onclick="filtrarPrejuizo()" class="bg-red-600 text-white p-3 rounded font-semibold hover:bg-red-700">ðŸ“‰ Ver prejuÃ­zo com ConvÃªnio</button>
      <button onclick="verLucro()" class="bg-green-600 text-white p-3 rounded font-semibold hover:bg-green-700">âœ… Ver exames com lucro</button>
      <button onclick="adicionarLucro()" class="bg-yellow-500 text-white p-3 rounded font-semibold hover:bg-yellow-600">ðŸ§® Aplicar % lucro</button>
      <button onclick="verNomesDiferentes()" class="bg-purple-500 text-white p-3 rounded font-semibold hover:bg-purple-600">ðŸš© Detectar nomes diferentes</button>
      <div class="relative">
        <button onclick="toggleExportMenu()" class="bg-gray-800 text-white p-3 w-full rounded font-semibold hover:bg-gray-900">ðŸ§¾ ExportaÃ§Ã£o â–¼</button>
        <div id="exportMenu" class="hidden absolute z-10 mt-1 bg-white border shadow-md rounded w-full">
          <button onclick="exportarExcel()" class="w-full text-left px-4 py-2 hover:bg-gray-100">Exportar para Excel</button>
          <button onclick="exportarPDF()" class="w-full text-left px-4 py-2 hover:bg-gray-100">Exportar para PDF</button>
        </div>
      </div>
    </div>

    <!-- Resultado -->
    <div id="resultado" class="overflow-auto text-sm"></div>
  </div>

  <script>
    let dadosA = [], dadosB = [], dadosConvenio = [];

    document.getElementById("fileA").addEventListener("change", (e) => {
      lerArquivoExcel(e.target.files[0], (dados) => dadosA = dados);
    });

    document.getElementById("fileB").addEventListener("change", (e) => {
      lerArquivoExcel(e.target.files[0], (dados) => dadosB = dados);
    });

    document.getElementById("fileConvenio").addEventListener("change", (e) => {
      lerArquivoExcel(e.target.files[0], (dados) => dadosConvenio = dados);
    });

    function lerArquivoExcel(file, callback) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const primeiraPlanilha = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[primeiraPlanilha];
        const json = XLSX.utils.sheet_to_json(worksheet);
        callback(json);
      };
      reader.readAsArrayBuffer(file);
    }

    function compararPlanilhas() {
      if (!dadosA.length || !dadosB.length) return alert("Anexe os arquivos A e B.");

      const resultado = [];
      dadosA.forEach((itemA) => {
        const correspondenteB = dadosB.find((itemB) => itemB.Exame?.toLowerCase().trim() === itemA.Exame?.toLowerCase().trim());
        if (correspondenteB) {
          resultado.push({
            Exame: itemA.Exame,
            ValorA: itemA.Valor,
            ValorB: correspondenteB.Valor,
            DiferenÃ§a: (itemA.Valor - correspondenteB.Valor).toFixed(2)
          });
        }
      });

      mostrarTabela(resultado, ["Exame", "ValorA", "ValorB", "DiferenÃ§a"]);
    }

    function filtrarPrejuizo() {
      if (!dadosB.length || !dadosConvenio.length) return alert("Anexe os arquivos B e ConvÃªnio.");

      const resultado = [];
      dadosB.forEach((itemB) => {
        const convenio = dadosConvenio.find((item) => item.Exame?.toLowerCase().trim() === itemB.Exame?.toLowerCase().trim());
        if (convenio && convenio.Valor < itemB.Valor) {
          resultado.push({
            Exame: itemB.Exame,
            ValorB: itemB.Valor,
            ValorConvenio: convenio.Valor,
            PrejuÃ­zo: (itemB.Valor - convenio.Valor).toFixed(2)
          });
        }
      });

      mostrarTabela(resultado, ["Exame", "ValorB", "ValorConvenio", "PrejuÃ­zo"]);
    }

    function verLucro() {
      if (!dadosB.length || !dadosConvenio.length) return alert("Anexe os arquivos B e ConvÃªnio.");

      const resultado = [];
      dadosB.forEach((itemB) => {
        const convenio = dadosConvenio.find((item) => item.Exame?.toLowerCase().trim() === itemB.Exame?.toLowerCase().trim());
        if (convenio && convenio.Valor >= itemB.Valor) {
          resultado.push({
            Exame: itemB.Exame,
            ValorB: itemB.Valor,
            ValorConvenio: convenio.Valor,
            Lucro: (convenio.Valor - itemB.Valor).toFixed(2)
          });
        }
      });

      mostrarTabela(resultado, ["Exame", "ValorB", "ValorConvenio", "Lucro"]);
    }

    function adicionarLucro() {
      if (!dadosB.length) return alert("Anexe o arquivo B.");

      const porcentagem = prompt("Digite a porcentagem de lucro a aplicar (ex: 20 para 20%):");
      const lucro = parseFloat(porcentagem);
      if (isNaN(lucro)) return alert("Porcentagem invÃ¡lida.");

      const resultado = dadosB.map((item) => ({
        Exame: item.Exame,
        ValorOriginal: item.Valor,
        ValorComLucro: (item.Valor * (1 + lucro / 100)).toFixed(2)
      }));

      mostrarTabela(resultado, ["Exame", "ValorOriginal", "ValorComLucro"]);
    }

    function verNomesDiferentes() {
      if (!dadosA.length || !dadosB.length) return alert("Anexe os arquivos A e B.");

      const nomesA = dadosA.map(item => item.Exame?.toLowerCase().trim());
      const nomesB = dadosB.map(item => item.Exame?.toLowerCase().trim());

      const diferentes = nomesA.filter(nome => !nomesB.includes(nome)).map(nome => {
        const item = dadosA.find(i => i.Exame?.toLowerCase().trim() === nome);
        return { Exame: item?.Exame };
      });

      mostrarTabela(diferentes, ["Exame"]);
    }

    function mostrarTabela(dados, colunas) {
      const resultadoDiv = document.getElementById("resultado");
      if (!dados.length) return resultadoDiv.innerHTML = "<p class='text-center text-red-600'>Nenhum dado encontrado.</p>";

      let html = "<table class='min-w-full table-auto border border-gray-300'><thead><tr>";
      colunas.forEach(col => {
        html += `<th class='border px-4 py-2 bg-gray-200'>${col}</th>`;
      });
      html += "</tr></thead><tbody>";

      dados.forEach(linha => {
        html += "<tr>";
        colunas.forEach(col => {
          html += `<td class='border px-4 py-1 text-center'>${linha[col]}</td>`;
        });
        html += "</tr>";
      });

      html += "</tbody></table>";
      resultadoDiv.innerHTML = html;
    }

    function toggleExportMenu() {
      const menu = document.getElementById("exportMenu");
      menu.classList.toggle("hidden");
    }

    function exportarExcel() {
      const tabela = document.querySelector("#resultado table");
      if (!tabela) return alert("Nenhum resultado para exportar.");

      const worksheet = XLSX.utils.table_to_sheet(tabela);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Resultado");
      XLSX.writeFile(workbook, "resultado_comparacao.xlsx");
    }

    function exportarPDF() {
      const resultado = document.getElementById("resultado");
      if (!resultado) return alert("Nenhum resultado para exportar.");

      const doc = new jspdf.jsPDF("p", "pt", "a4");
      doc.html(resultado, {
        callback: function (doc) {
          doc.save("resultado_comparacao.pdf");
        },
        x: 10,
        y: 10
      });
    }
  </script>
</body>
</html>
